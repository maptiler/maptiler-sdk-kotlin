name: Publish to Central

on:
  workflow_dispatch:
    inputs:
      note:
        description: "Runs ./gradlew publish then centralManualUpload (automatic)"
        required: false
        type: string

jobs:
  publish:
    name: Publish and Central Upload
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      # Sonatype token credentials
      SONATYPE_MAPTILER_TOKEN_USERNAME: ${{ secrets.SONATYPE_MAPTILER_TOKEN_USERNAME }}
      SONATYPE_MAPTILER_TOKEN_PASSWORD: ${{ secrets.SONATYPE_MAPTILER_TOKEN_PASSWORD }}

      # Gradle signing (in-memory PGP) â€“ no gpg agent required
      SONATYPE_MAPTILER_SIGNING_KEY_ID: ${{ secrets.SONATYPE_MAPTILER_SIGNING_KEY_ID }}
      SONATYPE_MAPTILER_SIGNING_KEY: ${{ secrets.SONATYPE_MAPTILER_SIGNING_KEY }}
      SONATYPE_MAPTILER_SIGNING_PASSWORD: ${{ secrets.SONATYPE_MAPTILER_SIGNING_PASSWORD }}

      # Optional overrides supported by build.gradle.kts (uncomment/setup in repo secrets if needed)
      # SONATYPE_MAPTILER_NAMESPACE: ${{ secrets.SONATYPE_MAPTILER_NAMESPACE }}
      # SONATYPE_MAPTILER_REPOSITORY_KEY: ${{ secrets.SONATYPE_MAPTILER_REPOSITORY_KEY }}
      # SONATYPE_MAPTILER_USE_KEY_NO_ID: ${{ secrets.SONATYPE_MAPTILER_USE_KEY_NO_ID }} # "true" to use key without ID

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Show Gradle version
        run: ./gradlew --version

      - name: Publish to Sonatype (staging or snapshots)
        run: ./gradlew publish --stacktrace --no-daemon

      - name: Trigger Central manual upload (automatic)
        run: ./gradlew :MapTilerSDK:centralManualUpload -PsonatypeMaptilerPublishingType=automatic --stacktrace --no-daemon
