name: PR Tests and Auto-Fix (Kotlin)

on:
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: pr-autofix-${{ github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  test:
    name: Run Kotlin tests
    # Run only for bot-authored PRs (robust check)
    if: ${{ github.event.pull_request.user.type == 'Bot' || github.actor == 'github-actions[bot]' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5

      - id: tests
        name: Run unit tests (capture log)
        continue-on-error: true
        run: |
          set -o pipefail
          ./gradlew test --stacktrace 2>&1 | tee gradle-test.log

      - name: Upload test log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gradle-test-log
          path: gradle-test.log

      - id: set_status
        name: Set job output if tests failed
        run: |
          if [ "${{ steps.tests.outcome }}" = "failure" ]; then
            echo "tests_failed=true" >> "$GITHUB_OUTPUT"
          else
            echo "tests_failed=false" >> "$GITHUB_OUTPUT"
          fi
    outputs:
      tests_failed: ${{ steps.set_status.outputs.tests_failed }}

  autofix:
    name: Run Codex auto-fix on failures
    needs: test
    # Only attempt auto-fix when tests_failed output is true and PR is bot-authored
    if: ${{ needs.test.outputs.tests_failed == 'true' && (github.event.pull_request.user.type == 'Bot' || github.actor == 'github-actions[bot]') }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR head branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Download failing test log
        uses: actions/download-artifact@v4
        with:
          name: gradle-test-log
          path: .

      - id: failure_excerpt
        name: Prepare failure excerpt for prompt
        shell: bash
        run: |
          {
            echo 'FAILURE_EXCERPT<<EOF'
            if command -v gsed >/dev/null 2>&1; then SED=gsed; else SED=sed; fi
            # Capture relevant Gradle failures and failing test lines; fallback to last 400 lines
            (grep -E "(FAILURE:|There were failing tests|\bFAILED\b|\berror\b|Exception:)" -n gradle-test.log || tail -n 400 gradle-test.log) | $SED -e 's/\r$//'
            echo EOF
          } >> "$GITHUB_ENV"

      - name: Configure Git author
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - id: guard
        name: Guard against repeated auto-fix attempts
        run: |
          last_msg="$(git log -1 --pretty=%s || true)"
          if echo "$last_msg" | grep -qi '^ci: codex auto-fix for failing tests'; then
            echo "already=true" >> $GITHUB_OUTPUT
            echo "Most recent commit is an auto-fix; skipping Codex run."
          else
            echo "already=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Codex Action
        if: ${{ steps.guard.outputs.already == 'false' }}
        uses: openai/codex-action@v1
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt: |
            Kotlin/Gradle unit tests failed on this PR. Analyze the failure log and make minimal, high-quality code changes that fix the issues while preserving intended behavior and established project style. Re-run tests locally if needed before finalizing.

            Constraints:
            - Only modify code relevant to the failures.
            - Keep changes small and focused.
            - Maintain ktlint style and Kotlin idioms.
            - Do not alter unrelated workflows or configuration.

            Failure log excerpt:
            ${{ env.FAILURE_EXCERPT }}

      - name: Gradle ktlintFormat
        if: ${{ steps.guard.outputs.already == 'false' }}
        run: ./gradlew -Dorg.gradle.daemon=false ktlintFormat || true

      - name: Commit changes if any
        if: ${{ steps.guard.outputs.already == 'false' }}
        run: |
          git add -A
          git commit -m "ci: codex auto-fix for failing tests" || echo "No changes to commit"

      - name: Push changes to PR branch
        if: ${{ steps.guard.outputs.already == 'false' }}
        run: |
          # Only push if there are new commits
          if [ -n "$(git log origin/${{ github.event.pull_request.head.ref }}..HEAD)" ]; then
            git push origin HEAD:${{ github.event.pull_request.head.ref }}
          else
            echo "No changes to push"
          fi

